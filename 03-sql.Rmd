# SQL {#sql}

```{r, include=F}
# library(RMariaDB)
library(RSQLite)
library(DBI)

# Establish a connection to sqlite databases
chinook <- dbConnect(RSQLite::SQLite(), "chinook.db")
lahman <- dbConnect(RSQLite::SQLite(), "lahman.db")

# Establish a connection to mysql databases
# connection <- dbConnect(RMariaDB::MariaDB(),
#                       host="scholar-db.rcac.purdue.edu",
#                       db="elections",
#                       user="elections_user",
#                       password="Dataelect!98")
```

```{r, eval=F}
library(RMariaDB)
library(RSQLite)
library(DBI)

# Establish a connection to sqlite databases
chinook <- dbConnect(RSQLite::SQLite(), "chinook.db")
lahman <- dbConnect(RSQLite::SQLite(), "lahman.db")

# Establish a connection to mysql databases
connection <- dbConnect(RMariaDB::MariaDB(),
                      host="your-host.com",
                      db="your-database-name",
                      user="your-username",
                      password="your-password")
```

### RDBMS {#sql-rdbms}

### SQL in R {#sql-in-r}

#### Examples {#sql-in-r-examples}

Please see [here](https://raw.githubusercontent.com/TheDataMine/the-examples-book/master/files/think-summer-examples-2020.pdf) for a variety of examples demonstrating using SQL within R.

### SQL in Python {#sql-in-python}

### Examples {#sql-examples}

The following examples use the `lahman.db` sqlite database.

#### Display the first 10 ballparks in the `ballparks` table.

<details>
    <summary>Click here for solution</summary>
```{sql, connection=lahman}
SELECT * FROM parks LIMIT 10;
```
</details>

#### Make a list of the names of all of the inactive teams in baseball history.

<details>
    <summary>Click here for solution</summary>

Remove the LIMIT 10 for full results.
```{sql, connection=lahman}
SELECT franchName FROM teamsfranchises WHERE active=='N' LIMIT 10;
```
</details>

#### Find the player with the most Runs Batted In (RBIs) in a season in queries. In the first query find the playerID of the player with the most RBIs. In the second query find the player's name in the `people` table.

<details>
    <summary>Click here for solution</summary>
    
In addition to his RBI record, Hack Wilson also held the NL home run record for a long time as well with 56. In 1999, Manny Ramirez tried to pursue the RBI record, but only was able to accrue 165 RBIs.
```{sql, connection=lahman}
-- Find the playerID
SELECT playerID FROM batting WHERE RBI==191;

-- Display the name
SELECT nameFirst, nameLast FROM people WHERE playerID=='wilsoha01';
```
</details>

#### Who was the manager of the 1976 "Big Red Machine" (CIN)? Complete this in 2 queries.

<details>
    <summary>Click here for solution</summary>
  
The "Big Red Machine" was a famous nickname for the dominant Cincinnati Reds of the early 1970s. Many of its team members are Hall of Famers, including their manager, Sparky Anderson.
    
```{sql, connection=lahman}
SELECT playerID FROM managers 
  WHERE yearID==1976 AND teamID=='CIN';

SELECT nameFirst, nameLast FROM people 
  WHERE playerID=='andersp01';
```
</details>

#### Make a list of the teamIDs that were managed by Tony LaRussa. Complete this in 2 queries.

<details>
    <summary>Click here for solution</summary>
    
Tony LaRussa is very well known for being a manager that was involved in baseball for a very long time. He won the World Series with the St. Louis Cardinals and the Oakland Athletics.

```{sql, connection=lahman}
SELECT playerID FROM people WHERE nameLast=='LaRussa' AND nameFirst=='Tony';

SELECT DISTINCT teamID FROM managers WHERE playerID=='larusto01';
```
</details>

#### What was Cecil Fielder's salary in 1987? Display the teamID with the salary. 

<details>
    <summary>Click here for solution</summary>

Cecil Fielder was a power hitting DH in the 1980s and 1990s. His son, Prince Fielder, played in the major leagues as well.

```{sql, connection=lahman}
SELECT playerID FROM people 
  WHERE nameFirst=='Cecil' AND nameLast=='Fielder';

SELECT teamID, salary FROM salaries 
  wHERE playerID=='fieldce01' AND yearID==1987;
```
</details>

#### Make a list of all the teams who have lost a World Series (WS) since 1990. Put the list in ascending order by `yearID`.

<details>
    <summary>Click here for solution</summary>
```{sql, connection=lahman}
SELECT teamIDloser, yearID FROM seriespost
  WHERE yearID >= 1990 AND round=='WS'
  ORDER BY yearID ASC LIMIT 10;
```
</details>

#### Let's find out about Cal Ripken, Jr. What was his height and weight? Did he bat right or left handed? When did he play his final game? Find all of this information in one query.

<details>
    <summary>Click here for solution</summary>
  
Cal Ripken, Jr's nickname is the "Iron Man" of baseball due to the fact that he started in 2,632 straight games. That means in just over 16 seasons, Cal Ripken, Jr. never missed a game!

```{sql, connection=lahman}
SELECT height, weight, bats, finalgame FROM people 
  WHERE nameFirst=='Cal' AND nameLast=='Ripken'
  AND deathState IS NULL;
```
</details>

#### Select all the playerIDs and yearIDs of the players who were inducted in the hall of fame and voted in by the Veterans committee, between 1990 and 2000. Put the list in descending order.

<details>
    <summary>Click here for solution</summary>
    
The veterans committee in the Hall of Fame voting process place players in the Hall of Fame that are forgotten by the writers, fans, etc. This is a way for players to recognize who they think were the greatest players of all time, or are skipped over for a variety of reasons. This is one reason why there is a lot of scrutiny in the process for how players are selected to the baseball hall of fame.

```{sql, connection=lahman}
SELECT playerID, yearID FROM halloffame 
  WHERE votedBy=='Veterans' AND inducted=='Y'
  AND yearID BETWEEN 1990 AND 2000
  ORDER BY yearID DESC LIMIT 10; 
```
</details>

#### Get a list of the attendance by season of the Toronto Blue Jays (TOR). What season was the highest attendance?

<details>
    <summary>Click here for solution</summary>
    
The Toronto Blue Jays were the 1993 season's World Series champion. This means that, yes, a non-USA team has won the World Series for baseball!

```{sql, connection=lahman}
SELECT yearkey, attendance FROM homegames 
  WHERE teamkey=='TOR' 
  ORDER BY attendance DESC LIMIT 10;
```
</details>

#### How many different leagues have represented Major League Baseball over time?

<details>
    <summary>Click here for solution</summary>
    
Major League Baseball has had several leagues that have been represented in its history. There are only two current leagues: National League and the American League.

```{sql, connection=lahman}
SELECT DISTINCT league FROM leagues;
```
</details>

The following examples use the `chinook.db` sqlite database.

```{r}
dbListTables(chinook)
```

#### How do I select all of the rows of a table called employees?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT * FROM employees;
```
</details>

#### How do I select the first 5 rows of a table called employees?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT * FROM employees LIMIT 5;
```
</details>

#### How do I select specific rows of a table called employees?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT LastName, FirstName FROM employees;
```
    
You can switch the order in which the columns are displayed as well:
```{sql, connection=chinook}
SELECT FirstName, LastName FROM employees;
```
</details>

#### How do I select only unique values from a column?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT DISTINCT Title FROM employees;
```
</details>

#### How can I filter that match a certain criteria?

<details>
    <summary>Click here for solution</summary>
    
Select only employees with a FirstName "Steve":
```{sql, connection=chinook}
SELECT * FROM employees WHERE FirstName='Steve';
```

Select only employees with FirstName "Steve" OR FirstName "Laura":
```{sql, connection=chinook}
SELECT * FROM employees WHERE FirstName='Steve' OR FirstName='Laura';
```

Select only employees with FirstName "Steve" AND LastName "Laura":
```{sql, connection=chinook}
SELECT * FROM employees WHERE FirstName='Steve' AND LastName='Laura';
```
As expected, there are no results! There is nobody with the full name "Steve Laura".
</details>


#### List the first 10 tracks from the `tracks` table.

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT * FROM tracks LIMIT 10;
```
</details>

#### How many rows or records are in the table named `tracks`?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT COUNT(*) FROM tracks;
```
</details>

#### Are there any artists with the names: "Elis Regina", "Seu Jorge", or "The Beatles"?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT * FROM artists WHERE Name='Elis Regina' OR Name='Seu Jorge' OR Name='The Beatles';
```
</details>

#### What albums did the artist with `ArtistId` of 41 make?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT * FROM albums WHERE ArtistId=41;
```
</details>

#### What are the tracks of the album with `AlbumId` of 71? Order the results from most `Milliseconds` to least.

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT * FROM tracks WHERE AlbumId=71 ORDER BY Milliseconds DESC;
```
</details>

#### What are the tracks of the album with `AlbumId` of 71? Order the results from longest to shortest and convert `Milliseconds` to seconds. Use aliasing to name the calculated field `Seconds`.

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT Milliseconds/1000.0 AS Seconds, * FROM tracks WHERE AlbumId=71 ORDER BY Seconds DESC;
```
</details>

#### What are the tracks that are at least 250 seconds long?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT Milliseconds/1000.0 AS Seconds, * FROM tracks WHERE Seconds >= 250;
```
</details>

#### What are the tracks that are between 250 and 300 seconds long?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT Milliseconds/1000.0 AS Seconds, * FROM tracks WHERE Seconds BETWEEN 250 AND 300 ORDER BY Seconds;
```
</details>

#### What is the `GenreId` of the genre with name `Pop`?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT GenreId FROM genres WHERE Name='Pop';
```
</details>

#### What is the average length (in seconds) of a track with genre "Pop"?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT AVG(Milliseconds/1000.0) AS avg FROM tracks WHERE genreId=9;
```
</details>

#### What is the longest Bossa Nova track (in seconds)?

<details>
    <summary>Click here for solution</summary>
    
What is the `GenreId` of Bossa Nova?
```{sql, connection=chinook}
SELECT GenreId FROM genres WHERE Name='Bossa Nova';
```
```{sql, connection=chinook}
SELECT *, MAX(Milliseconds/1000.0) AS Seconds FROM tracks WHERE genreId=11;
```
</details>

#### Get the average price per hour for Bossa Nova music (`genreId` of 11).

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT AVG(UnitPrice/Milliseconds/1000.0/3600) AS 'Price per Hour' FROM tracks WHERE genreId=11;
```
</details>

#### Get the average time (in seconds) for tracks by genre.

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT genreId, AVG(Milliseconds/1000.0) AS 'Average seconds per track' FROM tracks GROUP BY genreId;
```

We can use an INNER JOIN to get the name of each genre as well.
```{sql, connection=chinook}
SELECT g.Name, track_time.'Average seconds per track' FROM genres AS g INNER JOIN (SELECT genreId, AVG(Milliseconds/1000.0) AS 'Average seconds per track' FROM tracks GROUP BY genreId) AS track_time ON g.GenreId=track_time.GenreId ORDER BY track_time.'Average seconds per track' DESC;
```

</details>

#### What is the average price per track for each genre?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT genreId, AVG(UnitPrice) AS 'Average seconds per track' FROM tracks GROUP BY genreId;
```
</details>

#### What is the average number of tracks per album?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT AVG(trackCount) FROM (SELECT COUNT(*) AS trackCount FROM tracks GROUP BY albumId) AS track_count;
```
</details>

#### What is the average number of tracks per album per genre?

<details>
    <summary>Click here for solution</summary>
```{sql, connection=chinook}
SELECT genreId, AVG(trackCount) FROM (SELECT genreId, COUNT(*) AS trackCount FROM tracks GROUP BY albumId) AS track_count GROUP BY genreId;
```

```{sql, connection=chinook}
SELECT Name, avg_track_count.'Average Track Count' FROM genres AS g INNER JOIN (SELECT genreId, AVG(trackCount) AS 'Average Track Count' FROM (SELECT genreId, COUNT(*) AS trackCount FROM tracks GROUP BY albumId) AS track_count GROUP BY genreId) AS avg_track_count ON g.GenreId=avg_track_count.genreId;
```
</details>



The following examples us the `lahman.db` sqlite database.

```{r}
dbListTables(lahman)
```

